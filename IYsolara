local Settings = {
    ESPenabled = false,
    ChamsEnabled = false,
    BodyEnabled = false,
    espTransparency = 0.5,
    bodyColor = Color3.fromRGB(0, 255, 0), -- Default color for Body feature
}

-- Core GUI and Services
local COREGUI = game.CoreGui
local Players = game.Players
local RunService = game:GetService("RunService")

-- Utility Functions
local function round(num, decimalPlaces)
    local mult = 10^(decimalPlaces or 0)
    return math.floor(num * mult + 0.5) / mult
end

local function getRoot(character)
    return character and character:FindFirstChild("HumanoidRootPart")
end

local function createESP(plr)
    local ESPholder = Instance.new("Folder")
    ESPholder.Name = plr.Name..'_ESP'
    ESPholder.Parent = COREGUI

    for _, part in pairs(plr.Character:GetChildren()) do
        if part:IsA("BasePart") then
            local adornment = Instance.new("BoxHandleAdornment")
            adornment.Name = plr.Name
            adornment.Parent = ESPholder
            adornment.Adornee = part
            adornment.AlwaysOnTop = true
            adornment.ZIndex = 10
            adornment.Size = part.Size
            adornment.Transparency = Settings.espTransparency
            adornment.Color = plr.TeamColor
        end
    end

    if plr.Character and plr.Character:FindFirstChild('Head') then
        local billboardGui = Instance.new("BillboardGui")
        local textLabel = Instance.new("TextLabel")
        billboardGui.Adornee = plr.Character.Head
        billboardGui.Name = plr.Name
        billboardGui.Parent = ESPholder
        billboardGui.Size = UDim2.new(0, 100, 0, 150)
        billboardGui.StudsOffset = Vector3.new(0, 1, 0)
        billboardGui.AlwaysOnTop = true

        textLabel.Parent = billboardGui
        textLabel.BackgroundTransparency = 1
        textLabel.Position = UDim2.new(0, 0, 0, -50)
        textLabel.Size = UDim2.new(0, 100, 0, 100)
        textLabel.Font = Enum.Font.SourceSansSemibold
        textLabel.TextSize = 20
        textLabel.TextColor3 = Color3.new(1, 1, 1)
        textLabel.TextStrokeTransparency = 0
        textLabel.TextYAlignment = Enum.TextYAlignment.Bottom
        textLabel.Text = 'Name: '..plr.Name

        local function espLoop()
            if COREGUI:FindFirstChild(plr.Name..'_ESP') then
                if plr.Character and getRoot(plr.Character) and plr.Character:FindFirstChildOfClass("Humanoid") and Players.LocalPlayer.Character and getRoot(Players.LocalPlayer.Character) and Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
                    local pos = math.floor((getRoot(Players.LocalPlayer.Character).Position - getRoot(plr.Character).Position).magnitude)
                    textLabel.Text = 'Name: '..plr.Name..' | Health: '..round(plr.Character:FindFirstChildOfClass('Humanoid').Health, 1)..' | Studs: '..pos
                end
            end
        end

        RunService.RenderStepped:Connect(espLoop)
    end
end

local function createBody(plr)
    local bodyFolder = Instance.new("Folder")
    bodyFolder.Name = plr.Name..'_Body'
    bodyFolder.Parent = COREGUI

    repeat wait(1) until plr.Character and getRoot(plr.Character) and plr.Character:FindFirstChildOfClass("Humanoid")
    for _, part in pairs(plr.Character:GetChildren()) do
        if part:IsA("BasePart") then
            local adornment = Instance.new("BoxHandleAdornment")
            adornment.Name = plr.Name
            adornment.Parent = bodyFolder
            adornment.Adornee = part
            adornment.AlwaysOnTop = true
            adornment.ZIndex = 10
            adornment.Size = part.Size
            adornment.Transparency = 0.5
            adornment.Color = Settings.bodyColor
        end
    end
end

local function updateESPForPlayer(plr)
    if Settings.ESPenabled then
        createESP(plr)
    end
    if Settings.BodyEnabled then
        createBody(plr)
    end
end

Players.PlayerAdded:Connect(function(plr)
    if Settings.ESPenabled or Settings.BodyEnabled then
        updateESPForPlayer(plr)
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    local espFolder = COREGUI:FindFirstChild(plr.Name..'_ESP')
    if espFolder then espFolder:Destroy() end

    local bodyFolder = COREGUI:FindFirstChild(plr.Name..'_Body')
    if bodyFolder then bodyFolder:Destroy() end
end)

return Settings;
